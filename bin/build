#!/bin/bash -ex

APP_ROOT=$(git rev-parse --show-toplevel)
cd "$APP_ROOT"

CONFIG_DIR="$1"
if [ -z "$CONFIG_DIR" ]; then
    cat <<EOS
$0 must specify build config directory
e.g.
    $0 builds/planet
    $0 builds/Seattle
EOS
    exit 1
fi
shift

set -o nounset

if [ ! -d "$CONFIG_DIR" ]; then
    cat <<EOS
Config dir "$CONFIG_DIR" doesn't exist
EOS
    exit 1
fi

source bin/_source-env.sh "$CONFIG_DIR"

bin/update-fetch-urls

if [ -f "${CONFIG_DIR}/prebuild.sh" ]; then
    "${CONFIG_DIR}/prebuild.sh"
fi

USE_LOCAL_PBF=""
INPUT_PBF="${HEADWAY_AREA}.osm.pbf"
if [[ -f "${INPUT_PBF}" ]]; then
    USE_LOCAL_PBF="--local-pbf ${INPUT_PBF}"
fi

dagger --progress=plain -c "with-area ${HEADWAY_AREA} --countries=${HEADWAY_COUNTRIES} ${USE_LOCAL_PBF} | build | export data/${HEADWAY_AREA}"

TRANSIT_CONFIG_DIR="$CONFIG_DIR/transit"
if [ -d "$TRANSIT_CONFIG_DIR" ]; then
    bin/build-transit "$CONFIG_DIR"
fi

echo "Next, run: git co . && k8s/bin/regenerate-all"
