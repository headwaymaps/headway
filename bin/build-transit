#!/bin/bash -i

set -e

APP_ROOT=$(git rev-parse --show-toplevel)
cd "$APP_ROOT"

CONFIG_DIR="$1"
if [ -z "$CONFIG_DIR" ]; then
    cat <<EOS
$0 must specify build config directory
e.g.
    $0 builds/planet
    $0 builds/seattle
EOS
    exit 1
fi
shift

if [ ! -d "$CONFIG_DIR" ]; then
    cat <<EOS
Config dir "$CONFIG_DIR" doesn't exist
EOS
    exit 1
fi

set -o nounset

TRANSIT_CONFIG_DIR="$CONFIG_DIR/transit"

source "${CONFIG_DIR}/env.sh"

set -x
if [[ $HEADWAY_DOWNLOAD_AREA_PBF ]]; then
    INPUT_PBF="data/${HEADWAY_AREA}/${HEADWAY_AREA}.osm.pbf"
    if [ ! -f "$INPUT_PBF" ]; then
        dagger -c "download-pbf ${HEADWAY_AREA} | file | export data/${HEADWAY_AREA}/${HEADWAY_AREA}.osm.pbf"
    else
        echo "${INPUT_PBF} already exists"
    fi
else
    INPUT_PBF="${HEADWAY_AREA}.osm.pbf"
fi

dagger --interactive -c "new | with-area ${HEADWAY_AREA} --local-pbf ${INPUT_PBF} | build-transit ${TRANSIT_CONFIG_DIR} | export 'data/${HEADWAY_AREA}/transit'"
